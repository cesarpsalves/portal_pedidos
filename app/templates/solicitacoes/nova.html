{# templates/solicitacoes/nova.html #}
{% extends 'base.html' %}
{% block title %}Nova Solicitação{% endblock %}

{% block content %}
<h2>Nova Solicitação</h2>

<!-- 1) Botão para ir à tela de Importação via Planilha -->
<p>
    <a href="{{ url_for('solicitacoes.importar_solicitacao') }}" class="botao-secundario">
        ← Importar via Planilha
    </a>
</p>

<!-- 2) Exibe mensagens de flash (sucesso ou erro) -->
{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
<ul class="flashes">
    {% for category, message in messages %}
    <li class="flash-{{ category }}">{{ message }}</li>
    {% endfor %}
</ul>
{% endif %}
{% endwith %}

<!-- 3) Formulário de Nova Solicitação -->
<form method="POST" action="{{ url_for('solicitacoes.nova_solicitacao') }}">
    {# Campo CSRF obrigatório #}
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

    <!-- Empresa Solicitante -->
    <label for="empresa_solicitante_id">Empresa Solicitante:</label>
    <select name="empresa_solicitante_id" id="empresa_solicitante_id" required>
        <option value="">Selecione...</option>
        {% for emp in empresas %}
        <option value="{{ emp.id }}">{{ emp.nome }}</option>
        {% endfor %}
    </select>
    <br><br>

    <!-- Finalidade (texto livre) -->
    <label for="finalidade">Finalidade (texto livre):</label><br>
    <input type="text" name="finalidade" id="finalidade" required class="maiusculo" spellcheck="true">
    <br><br>

    <!-- Centro de Custo -->
    <label for="centro_custo">Centro de Custo:</label>
    <select name="centro_custo" id="centro_custo" required>
        <option value="">Selecione...</option>
        <option value="Brindes Promocionais - 2.2.04.006">
            Brindes Promocionais – 2.2.04.006
        </option>
        <option value="Doação de Equipamentos - 2.2.04.014">
            Doação de Equipamentos – 2.2.04.014
        </option>
        <option value="Outros">Outros (informe em Observações)</option>
    </select>
    <br><br>

    <!-- Unidade -->
    <label for="unidade_id">Unidade:</label>
    <select name="unidade_id" id="unidade_id" required>
        <option value="">Selecione...</option>
        {% for unidade in unidades %}
        <option value="{{ unidade.id }}">{{ unidade.nome }}</option>
        {% endfor %}
    </select>
    <br><br>

    <!-- Tipo de Recebimento -->
    <label>Tipo de Recebimento:</label>
    <input type="radio" name="recebimento" value="RETIRADA" id="opt-retirada">
    <label for="opt-retirada">Retirada</label>
    <input type="radio" name="recebimento" value="ENTREGA" id="opt-entrega" checked>
    <label for="opt-entrega">Entrega</label>
    <br><br>

    <!-- Campos de Retirada (nome e CPF) -->
    <div id="campos-retirada" style="display: none;">
        <label for="nome_retirada">Nome de quem irá retirar:</label><br>
        <input type="text" name="nome_retirada" id="nome_retirada" class="maiusculo" spellcheck="true">
        <br>

        <label for="cpf_retirada">CPF de quem irá retirar:</label><br>
        <input type="text" name="cpf_retirada" id="cpf_retirada" maxlength="14">
        <br>
        <!-- O JS (IMask) inserir um <span id="erro-cpf-msg"> se necessário -->
    </div>
    <br>

    <!-- Prazo Limite de Entrega -->
    <label for="prazo_limite">Prazo Limite de Entrega:</label><br>
    <input type="date" name="prazo_limite" id="prazo_limite" min="{{ hoje }}" required>
    <br>
    <small id="dias-restantes" style="color: #555;"></small>
    <br><br>

    <!-- Itens da Solicitação -->
    <h3>Itens da Solicitação</h3>
    <div id="items">
        <div class="item">
            <!-- Nome do Produto com autocomplete via datalist -->
            <input type="text" name="nome_produto" placeholder="Nome do Produto" class="maiusculo"
                list="produtos_sugeridos" autocomplete="off" spellcheck="false">
            <datalist id="produtos_sugeridos">
                {% for termo in termos_produto %}
                <option value="{{ termo }}">
                    {% endfor %}
            </datalist>

            <!-- Nome Técnico -->
            <input type="text" name="nome_tecnico" placeholder="Nome Técnico" class="maiusculo" spellcheck="true">

            <!-- Quantidade -->
            <input type="text" name="quantidade" placeholder="Qtd">

            <!-- Voltagem -->
            <select name="voltagem">
                <option value="">Voltagem</option>
                <option value="110V">110V</option>
                <option value="220V">220V</option>
            </select>

            <!-- Especificações -->
            <input type="text" name="especificacoes" placeholder="Especificações" class="maiusculo" spellcheck="true">

            <!-- Link -->
            <input type="text" name="link" placeholder="Link">
        </div>
    </div>
    <button type="button" id="adicionarItem">+ Adicionar Item</button>
    <br><br>

    <!-- Observações -->
    <label for="observacao">
        Observações (se “Centro de Custo” for “Outros”, especifique):
    </label><br>
    <textarea name="observacao" id="observacao" rows="3" cols="50" spellcheck="true"></textarea>
    <br><br>

    <button type="submit">Enviar Solicitação</button>
    <br><br>
    {# → Aqui, substituir 'main.home' por 'main.home' #}
    <a href="{{ url_for('main.home') }}">← Voltar ao Dashboard</a>
</form>

<!-- 4) Scripts externos e específicos -->
<script src="{{ url_for('static', filename='js/form.js') }}" defer></script>
<script src="https://unpkg.com/imask"></script>

<script>
    // 5) Cálculo de dias restantes para o prazo (código original)
    document.getElementById("prazo_limite")?.addEventListener("input", function () {
        const escolha = this.value;
        const spanDias = document.getElementById("dias-restantes");
        if (!escolha) {
            spanDias.textContent = "";
            return;
        }
        const hoje = new Date("{{ hoje }}");
        const selecionada = new Date(escolha);
        const diffMs = selecionada - hoje;
        const diffDias = Math.round(diffMs / (1000 * 60 * 60 * 24));
        if (diffDias >= 0) {
            spanDias.textContent = `Prazo em ${diffDias} dia(s).`;
        } else {
            spanDias.textContent = "";
        }
    });
</script>
{% endblock %}