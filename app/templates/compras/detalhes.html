{# templates/compras/detalhes.html #}
{% extends "base.html" %}
{% block title %}Preencher Compra{% endblock %}

{% block content %}

<h2>Preencher Dados da Compra para Solicitação #{{ solicitacao.id }}</h2>

<hr>
<h3>Informações da Solicitação</h3>
<ul>
    <li><strong>Empresa Solicitante:</strong>
        {{ solicitacao.empresa_solicitante.nome if solicitacao.empresa_solicitante else "---" }}
    </li>
    <li><strong>Finalidade:</strong> {{ solicitacao.finalidade }}</li>
    <li><strong>Unidade:</strong> {{ solicitacao.unidade.nome if solicitacao.unidade else "---" }}</li>
    <li><strong>Solicitante (Usuário):</strong> {{ solicitacao.usuario.nome }}</li>
    <li><strong>Data da Solicitação:</strong>
        {{ solicitacao.criado_em.strftime('%d/%m/%Y %H:%M') }}
    </li>
    <li><strong>Status atual:</strong> {{ solicitacao.status }}</li>
</ul>
<hr>

<h3>Itens Solicitados ({{ itens|length }} {{ "item" if itens|length == 1 else "itens" }})</h3>
<table border="1" cellpadding="5" cellspacing="0">
    <thead>
        <tr>
            <th>Item ID</th>
            <th>Produto</th>
            <th>Qtd. Solicitada</th>
            <th>Voltagem</th>
            <th>Especificações</th>
            <th>Link</th>
        </tr>
    </thead>
    <tbody>
        {% for item in itens %}
        <tr>
            <td>{{ item.id }}</td>
            <td>{{ item.nome_produto }}</td>
            <td>{{ item.quantidade }}</td>
            <td>{{ item.voltagem or "---" }}</td>
            <td>{{ item.especificacoes or "---" }}</td>
            <td>
                {% if item.link %}
                <a href="{{ item.link }}" target="_blank">Link</a>
                {% else %}
                ---
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<hr>
<h3>Dados do Pagamento & Entrega</h3>
<form method="POST" enctype="multipart/form-data">
    {# CSRF token obrigatório #}
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

    <!-- 1) Forma de Pagamento -->
    <div style="margin-bottom: 1em;">
        <label for="forma_pagamento"><strong>Forma de Pagamento:</strong></label><br>
        <select name="forma_pagamento" id="forma_pagamento" required>
            <option value="">Selecione...</option>
            <option value="BOLETO">Boleto</option>
            <option value="PIX">Pix (QR Code)</option>
            <option value="CARTAO_CREDITO">Cartão de Crédito</option>
            <option value="DINHEIRO">Dinheiro</option>
            <option value="OUTRO">Outro</option>
        </select>
    </div>

    <!-- 2) Valor Total, Parcelamento, Desconto -->
    <div style="margin-bottom: 1em;">
        <label for="valor_total"><strong>Valor Total (R$):</strong></label><br>
        <input type="number" step="0.01" name="valor_total" id="valor_total" required placeholder="Ex: 1250.00">
    </div>
    <div style="margin-bottom: 1em;">
        <label for="parcelamento"><strong>Número de Parcelas:</strong></label><br>
        <input type="number" name="parcelamento" id="parcelamento" min="0" placeholder="Ex: 1, 2, 3...">
        <small>(Deixe em branco se for pagamento à vista)</small>
    </div>
    <div style="margin-bottom: 1em;">
        <label for="desconto"><strong>Desconto (R$):</strong></label><br>
        <input type="number" step="0.01" name="desconto" id="desconto" value="0.00">
    </div>

    <!-- 3) Últimos 4 dígitos (se aplicável) -->
    <div style="margin-bottom: 1em;">
        <label for="ultimos4"><strong>Últimos 4 dígitos do Cartão (se aplicável):</strong></label><br>
        <input type="text" name="ultimos4" id="ultimos4" maxlength="4" placeholder="Ex: 1234">
        <small>(Preencha apenas se tiver sido por cartão)</small>
    </div>

    <!-- 4) Nome da Loja / Plataforma (opcional) -->
    <div style="margin-bottom: 1em;">
        <label for="nome_loja"><strong>Nome da Loja / Plataforma (opcional):</strong></label><br>
        <input type="text" name="nome_loja" id="nome_loja" placeholder="Ex: Mercado Livre, Amazon, Magazine...">
    </div>

    <!-- 5) Categoria de Entrega -->
    <div style="margin-bottom: 1em;">
        <label><strong>Categoria de Entrega:</strong></label><br>
        <input type="radio" name="categoria_entrega" id="entrega_unico" value="unico" checked>
        <label for="entrega_unico">Pacote Único</label><br>
        <input type="radio" name="categoria_entrega" id="entrega_multiplo" value="multiplo">
        <label for="entrega_multiplo">Múltiplos Pacotes</label>
    </div>

    <hr>

    <!-- 6) Bloco Condicional: Pacote Único -->
    <div id="bloco-unico" style="margin-bottom: 2em; border: 1px solid #ccc; padding: 1em;">
        <h4>Pacote Único</h4>
        <div style="margin-bottom: 1em;">
            <label for="senha_recebimento_unico"><strong>Senha de Recebimento (opcional):</strong></label><br>
            <input type="text" name="senha_recebimento_unico" id="senha_recebimento_unico" placeholder="Ex: 9876">
        </div>
        <div style="margin-bottom: 1em;">
            <label for="data_prevista_entrega_unico"><strong>Data Prevista de Entrega:</strong></label><br>
            <input type="date" name="data_prevista_entrega_unico" id="data_prevista_entrega_unico">
        </div>
        <div style="margin-bottom: 1em;">
            <label for="nota_fiscal_unico"><strong>Anexar Nota Fiscal (opcional):</strong></label><br>
            <input type="file" name="nota_fiscal_unico" id="nota_fiscal_unico" accept=".pdf,.jpg,.png">
            <small>(Não obrigatório; pode ser enviado posteriormente)</small>
        </div>
    </div>

    <!-- 7) Bloco Condicional: Múltiplos Pacotes -->
    <div id="bloco-multiplo" style="display: none; margin-bottom: 2em; border: 1px solid #ccc; padding: 1em;">
        <h4>Múltiplos Pacotes</h4>
        <p>Para cada pacote, informe quantidade, senha, data e, se disponível, anexe a nota:</p>
        <table id="tabela-pacotes" border="1" cellpadding="5" cellspacing="0" style="width: 100%;">
            <thead>
                <tr>
                    <th>Pacote #</th>
                    <th>Qtd. no Pacote</th>
                    <th>Senha de Recebimento</th>
                    <th>Data Prevista Entrega</th>
                    <th>Nota Fiscal (opcional)</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody>
                {# As linhas serão criadas dinamicamente em JavaScript #}
            </tbody>
        </table>
        <br>
        <button type="button" id="btn-adicionar-pacote">+ Adicionar Pacote</button>
        <small style="display: block; margin-top: 0.5em;">
            (Anexar nota fiscal é opcional; pode ficar em branco e ser enviado depois.)
        </small>
    </div>

    <hr>
    <!-- 8) Informações Adicionais (qualquer observação extra) -->
    <div style="margin-bottom: 1em;">
        <label for="informacoes_adicionais"><strong>Informações Adicionais (opcional):</strong></label><br>
        <textarea name="informacoes_adicionais" id="informacoes_adicionais" rows="3" style="width: 100%;"></textarea>
    </div>

    <!-- 9) Botão de Envio -->
    <button type="submit">Salvar Compra</button>
    &nbsp;&nbsp;
    <a href="{{ url_for('compras.lista_compras') }}">← Voltar à lista de compras</a>
</form>

<br><br>

<!-- JavaScript para alternar blocos e adicionar pacotes -->
<script>
    // Referências aos elementos
    const radioUnico = document.getElementById("entrega_unico");
    const radioMultiplo = document.getElementById("entrega_multiplo");
    const blocoUnico = document.getElementById("bloco-unico");
    const blocoMultiplo = document.getElementById("bloco-multiplo");
    const tabelaPacotesBody = document.querySelector("#tabela-pacotes tbody");
    const btnAdicionar = document.getElementById("btn-adicionar-pacote");
    let contadorPacote = 0;

    // Função que alterna visibilidade dos blocos
    function atualizarBlocos() {
        if (radioUnico.checked) {
            blocoUnico.style.display = "block";
            blocoMultiplo.style.display = "none";
        } else {
            blocoUnico.style.display = "none";
            blocoMultiplo.style.display = "block";
        }
    }

    // Monitora mudança nos rádios
    radioUnico.addEventListener("change", atualizarBlocos);
    radioMultiplo.addEventListener("change", atualizarBlocos);

    // Adiciona nova linha de pacote quando clicar
    btnAdicionar.addEventListener("click", () => {
        contadorPacote += 1;
        const linha = document.createElement("tr");
        linha.innerHTML = `
      <td>${contadorPacote}</td>
      <td>
        <input type="number" name="pacote_${contadorPacote}_qtd" min="1" required style="width: 60px;">
      </td>
      <td>
        <input type="text" name="pacote_${contadorPacote}_senha" placeholder="opcional">
      </td>
      <td>
        <input type="date" name="pacote_${contadorPacote}_data" required>
      </td>
      <td>
        <input type="file" name="pacote_${contadorPacote}_nota" accept=".pdf,.jpg,.png">
      </td>
      <td>
        <button type="button" class="btn-remover-pacote">Remover</button>
      </td>
    `;
        tabelaPacotesBody.appendChild(linha);

        // Botão para remover a linha
        linha.querySelector(".btn-remover-pacote").addEventListener("click", () => {
            linha.remove();
        });
    });

    // Ajusta estado inicial ao carregar a página
    atualizarBlocos();
</script>

{% endblock %}